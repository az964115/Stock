<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI è‚¡å¸‚å„€è¡¨æ¿ Pro 2.4</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; padding:0; background:#121212; color:#e0e0e0; }
header { display:flex; justify-content:space-between; align-items:center; padding:20px 40px; background:#1e1e1e; border-bottom:1px solid #333;}
header h1 { margin:0; font-size:1.8rem;}
header button { padding:8px 16px; font-size:1rem; background:#333; color:#e0e0e0; border:none; border-radius:4px; cursor:pointer;}
header button:hover { background:#555;}
#stocks-container { display:flex; flex-direction:column; gap:15px; padding:20px 40px;}
.stock-card { background:#1f1f1f; border:1px solid #333; border-radius:8px; padding:12px; display:flex; align-items:center; gap:15px; cursor:pointer; transition:all 0.3s ease; max-height:90px; overflow:hidden;}
.stock-card.expanded { flex-direction:column; max-height:3000px; padding:20px;}
.stock-info { flex:1; display:flex; flex-direction:column; gap:4px;}
.stock-info h2 { margin:0; font-size:1.2rem; color:#00ffb0;}
.price-info { font-size:1rem; display:flex; gap:10px; align-items:center;}
.buy-score { padding:2px 6px; border-radius:4px; color:#000;}
canvas.k-mini { width:120px; height:50px;}
canvas.chart-full { width:100%; height:300px; margin-top:10px;}
.analysis-report { margin-top:10px; background:#2a2a2a; border-radius:6px; padding:10px; font-size:0.9rem; line-height:1.4;}
footer { text-align:center; padding:20px 0; background:#1e1e1e; border-top:1px solid #333; font-size:0.9rem; color:#999;}
body.light-mode { background:#f5f5f5; color:#212121;}
body.light-mode header { background:#fff; color:#212121; border-bottom:1px solid #ccc;}
body.light-mode .stock-card { background:#fff; border:1px solid #ccc; color:#212121;}
body.light-mode .analysis-report { background:#eee; color:#212121;}
body.light-mode header button { background:#ddd; color:#212121;}
body.light-mode header button:hover { background:#bbb;}
</style>
</head>
<body>
<header>
<h1>ğŸ“ˆ AI è‚¡å¸‚å„€è¡¨æ¿ Pro 2.4</h1>
<button id="toggleTheme">åˆ‡æ›äº®/æ·±è‰²æ¨¡å¼</button>
</header>
<main>
<div id="stocks-container"></div>
</main>
<footer>
<p>Â© 2025 AI è‚¡å¸‚å„€è¡¨æ¿ Pro 2.4</p>
</footer>

<script>
// ------------------- è‚¡ç¥¨åˆ—è¡¨ -------------------
const stockList=["2330.TW","2454.TW","0050.TW","0056.TW","VOO"];
const stocksContainer=document.getElementById('stocks-container');
document.getElementById('toggleTheme').addEventListener('click',()=>{document.body.classList.toggle('light-mode');});

// ------------------- æŠ€è¡“æŒ‡æ¨™ -------------------
function SMA(data, period){let r=[];for(let i=0;i<data.length;i++){if(i<period-1){r.push(null);continue;}let sum=0;for(let j=i-period+1;j<=i;j++) sum+=data[j];r.push(sum/period);} return r;}
function EMA(data, period){let r=[];let k=2/(period+1);data.forEach((v,i)=>{if(i===0) r.push(v); else r.push(v*k+r[i-1]*(1-k));}); return r;}
function RSI(data, period=14){let gains=[],losses=[];for(let i=1;i<data.length;i++){let c=data[i]-data[i-1];gains.push(c>0?c:0);losses.push(c<0?-c:0);} let rsi=[50]; for(let i=period;i<data.length;i++){let g=gains.slice(i-period+1,i+1).reduce((a,b)=>a+b,0)/period; let l=losses.slice(i-period+1,i+1).reduce((a,b)=>a+b,0)/period; rsi.push(100-(100/(1+g/l)));} return rsi;}
function calculateBuyScore(latest,ma20,ma60,ma200,rsi){let score=0;if(ma20>ma60&&ma60>ma200) score+=15;if(latest>ma20) score+=5;if(rsi<30) score+=15;if(latest<ma200) score+=10; return Math.min(Math.max(Math.round(score),0),100);}
function getSupportResistance(high,low){let h=Math.max(...high.slice(-20)),l=Math.min(...low.slice(-20)); return {support:l,resistance:h};}

// ------------------- å»ºç«‹å¡ç‰‡ -------------------
stockList.forEach(symbol=>{
    const card=document.createElement('div'); card.className='stock-card'; card.id=`stock-${symbol}`;
    card.innerHTML=`<div class="stock-info">
        <h2>${symbol}</h2>
        <div class="price-info">æœ€æ–°åƒ¹ï¼š<span class="latest-price">--</span> | BuyScoreï¼š<span class="buy-score">--</span></div>
        <div class="analysis-report">è¼‰å…¥ä¸­...</div>
    </div>
    <canvas class="k-mini"></canvas>
    <canvas class="chart-full"></canvas>`;
    stocksContainer.appendChild(card);

    card.addEventListener('click',()=>{card.classList.toggle('expanded');});
});

// ------------------- æŠ“ Yahoo Finance -------------------
async function fetchStockData(symbol, range='6mo', interval='1d'){
    try{
        const url=`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${range}&interval=${interval}`)}`;
        const res=await fetch(url);
        const data=await res.json();
        const timestamps=data.chart.result[0].timestamp;
        const quote=data.chart.result[0].indicators.quote[0];
        return {timestamps,open:quote.open,high:quote.high,low:quote.low,close:quote.close};
    }catch(err){console.error(symbol,err); return null;}
}

// ------------------- æ¸²æŸ“è³‡æ–™ -------------------
async function renderStock(symbol,card){
    const miniData=await fetchStockData(symbol,'1mo','1d');
    const fullData=await fetchStockData(symbol,'6mo','1d');
    if(!miniData || !fullData) return;

    const latest=fullData.close[fullData.close.length-1];
    const ma20=SMA(fullData.close,20).slice(-1)[0]||latest;
    const ma60=SMA(fullData.close,60).slice(-1)[0]||latest;
    const ma200=SMA(fullData.close,200).slice(-1)[0]||latest;
    const rsiVal=RSI(fullData.close,14).slice(-1)[0]||50;
    const buyScore=calculateBuyScore(latest,ma20,ma60,ma200,rsiVal);

    // æ›´æ–°æ–‡å­—èˆ‡ BuyScoreé¡è‰²
    const buySpan=card.querySelector('.buy-score');
    card.querySelector('.latest-price').textContent=latest.toFixed(2);
    buySpan.textContent=buyScore;
    if(buyScore>=70) buySpan.style.backgroundColor="#00ff00";
    else if(buyScore>=40) buySpan.style.backgroundColor="#ffeb3b";
    else buySpan.style.backgroundColor="#ff3b3b";

    // å°å¡æŠ˜ç·šåœ–
    const kMiniCanvas=card.querySelector('canvas.k-mini');
    new Chart(kMiniCanvas,{
        type:'line',
        data:{labels:miniData.timestamps.map(t=>new Date(t*1000).toLocaleDateString()),
              datasets:[{label:'æ”¶ç›¤',data:miniData.close,borderColor:'#00ffb0',fill:false,tension:0.2}]},
        options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}
    });

    // å±•é–‹å®Œæ•´ K ç·šåœ– + MA + RSI
    const fullCanvas=card.querySelector('canvas.chart-full');
    new Chart(fullCanvas,{
        type:'candlestick',
        data:{labels:fullData.timestamps.map(t=>new Date(t*1000).toLocaleDateString()),
              datasets:[{label:symbol,data:fullData.close.map((c,i)=>({o:fullData.open[i],h:fullData.high[i],l:fullData.low[i],c:c}))}]},
        options:{plugins:{legend:{display:true}}}
    });

    // è©³ç´°åˆ†æ
    const supportRes=getSupportResistance(fullData.high,fullData.low);
    card.querySelector('.analysis-report').innerHTML=`
        <p>è¶¨å‹¢åˆ¤æ–·ï¼š${ma20>ma60&&ma60>ma200?"ğŸŸ¢ å¼·å¤š":ma20<ma60&&ma60<ma200?"ğŸ”´ å¼·ç©º":"ğŸŸ¡ ä¸­æ€§"}</p>
        <p>RSIï¼š${rsiVal.toFixed(2)}</p>
        <p>MA20ï¼š${ma20.toFixed(2)}, MA60ï¼š${ma60.toFixed(2)}, MA200ï¼š${ma200.toFixed(2)}</p>
        <p>æ”¯æ’ï¼š${supportRes.support.toFixed(2)}, å£“åŠ›ï¼š${supportRes.resistance.toFixed(2)}</p>`;
}

// ------------------- è¼‰å…¥å°±æŠ“è³‡æ–™ -------------------
stockList.forEach(symbol=>{
    const card=document.getElementById(`stock-${symbol}`);
    renderStock(symbol,card);
});
</script>
</body>
</html>
