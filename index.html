<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ËÇ°Â∏ÇÂÑÄË°®Êùø Pro 2.0</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ------------------------
           ÂÖ®ÂüüÊ®£Âºè
        ------------------------ */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        header button {
            padding: 8px 16px;
            font-size: 1rem;
            background-color: #333;
            color: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        header button:hover {
            background-color: #555;
        }

        /* ------------------------
           ËÇ°Á•®Âç°Áâá
        ------------------------ */
        #stocks-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            padding: 20px 40px;
        }

        .stock-card {
            background-color: #1f1f1f;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .stock-card h2 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            color: #00ffb0;
        }

        .price-info {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .price-info span {
            font-weight: bold;
            color: #ffeb3b;
        }

        /* ------------------------
           ÂúñË°®Ê®£Âºè
        ------------------------ */
        canvas.chart-k {
            width: 100%;
            height: 500px;
            margin-bottom: 20px;
        }

        canvas.chart-rsi {
            width: 100%;
            height: 200px;
            margin-bottom: 20px;
        }

        canvas.chart-macd {
            width: 100%;
            height: 200px;
            margin-bottom: 20px;
        }

        /* ------------------------
           ÊäÄË°ìÂàÜÊûêÂ†±Âëä
        ------------------------ */
        .analysis-report {
            background-color: #2a2a2a;
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* ------------------------
           Footer
        ------------------------ */
        footer {
            text-align: center;
            padding: 20px 0;
            background-color: #1e1e1e;
            border-top: 1px solid #333;
            font-size: 0.9rem;
            color: #999;
        }

        /* ------------------------
           ‰∏ªÈ°åÂàáÊèõÔºà‰∫Æ/Ê∑±Ëâ≤Ê®°ÂºèÔºâ
        ------------------------ */
        body.light-mode {
            background-color: #f5f5f5;
            color: #212121;
        }

        body.light-mode header {
            background-color: #ffffff;
            color: #212121;
            border-bottom: 1px solid #ccc;
        }

        body.light-mode .stock-card {
            background-color: #ffffff;
            border: 1px solid #ccc;
            color: #212121;
        }

        body.light-mode .analysis-report {
            background-color: #eeeeee;
            color: #212121;
        }

        body.light-mode header button {
            background-color: #ddd;
            color: #212121;
        }

        body.light-mode header button:hover {
            background-color: #bbb;
        }
    </style>
</head>
<body class="dark-mode">
    <header>
        <h1>üìà AI ËÇ°Â∏ÇÂÑÄË°®Êùø Pro 2.0</h1>
        <button id="toggleTheme">ÂàáÊèõ‰∫Æ/Ê∑±Ëâ≤Ê®°Âºè</button>
    </header>

    <main>
        <div id="stocks-container">
            <!-- ËÇ°Á•®Âç°ÁâáÊúÉÂãïÊÖãÁîüÊàê -->
        </div>
    </main>

    <footer>
        <p>¬© 2025 AI ËÇ°Â∏ÇÂÑÄË°®Êùø Pro 2.0</p>
    </footer>

    <script>
        // -------------------------------
        // ËÇ°Á•®Ê∏ÖÂñÆ
        // -------------------------------
        const stockList = ["2330.TW", "2454.TW", "0050.TW", "0056.TW", "VOO"];

        // -------------------------------
        // ‰∏ªÈ°åÂàáÊèõ
        // -------------------------------
        const toggleBtn = document.getElementById('toggleTheme');
        toggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
        });

        // -------------------------------
        // ÊäÄË°ìÊåáÊ®ôË®àÁÆó
        // -------------------------------

        // Ë®àÁÆó SMA
        function SMA(data, period) {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = i - period + 1; j <= i; j++) sum += data[j];
                result.push(sum / period);
            }
            return result;
        }

        // Ë®àÁÆó EMA
        function EMA(data, period) {
            let result = [];
            let k = 2 / (period + 1);
            data.forEach((price, i) => {
                if (i === 0) result.push(price);
                else result.push(price * k + result[i-1] * (1 - k));
            });
            return result;
        }

        // Ë®àÁÆó RSI
        function RSI(data, period=14) {
            let gains = [];
            let losses = [];
            for (let i=1; i<data.length; i++) {
                let change = data[i] - data[i-1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
            }
            let avgGain = SMA(gains, period);
            let avgLoss = SMA(losses, period);
            let rsi = [null];
            for (let i=0; i<avgGain.length; i++) {
                if (avgGain[i] === null || avgLoss[i] === null) { rsi.push(null); continue; }
                rsi.push(100 - (100 / (1 + avgGain[i]/avgLoss[i])));
            }
            return rsi;
        }

        // Ë®àÁÆó MACD
        function MACD(data, short=12, long=26, signal=9) {
            let emaShort = EMA(data, short);
            let emaLong = EMA(data, long);
            let macd = emaShort.map((v, i) => v - emaLong[i]);
            let signalLine = EMA(macd, signal);
            let histogram = macd.map((v, i) => v - signalLine[i]);
            return {macd, signalLine, histogram};
        }

        // ATR
        function ATR(high, low, close, period=14) {
            let tr = [];
            for (let i=0; i<close.length; i++) {
                if(i===0) tr.push(high[i]-low[i]);
                else tr.push(Math.max(high[i]-low[i], Math.abs(high[i]-close[i-1]), Math.abs(low[i]-close[i-1])));
            }
            return SMA(tr, period);
        }

        // -------------------------------
        // ÊîØÊíê / Â£ìÂäõ
        // -------------------------------
        function getSupportResistance(high, low, close) {
            // Á∞°ÂñÆÊñπÊ≥ï: ÂèñÊúÄËøë 20 Êó•ÊúÄÈ´ò„ÄÅÊúÄ‰Ωé
            let recentHigh = Math.max(...high.slice(-20));
            let recentLow = Math.min(...low.slice(-20));
            return {support: recentLow, resistance: recentHigh};
        }

        // -------------------------------
        // AI BuyScore Ë®àÁÆó
        // -------------------------------
        function calculateBuyScore(latest, ma20, ma60, ma200, rsi, macdHist, atrPercent) {
            let score = 0;
            // Momentum
            if(ma20 > ma60 && ma60 > ma200) score += 15;
            if(latest > ma20) score +=5;
            if(macdHist > 0) score += 10;

            // Value
            if(rsi < 30) score +=15;
            if(latest < ma200) score +=10;

            // Risk
            if(atrPercent < 1.5) score +=10;
            if(atrPercent > 3) score -=10;

            return Math.min(Math.max(Math.round(score),0),100);
        }

        // -------------------------------
        // Ê∏≤ÊüìËÇ°Á•®Âç°Áâá
        // -------------------------------
        const stocksContainer = document.getElementById('stocks-container');

        stockList.forEach(symbol => {
            const card = document.createElement('div');
            card.className = 'stock-card';
            card.id = `stock-${symbol}`;

            card.innerHTML = `
                <h2>${symbol}</h2>
                <div class="price-info">
                    ÊúÄÊñ∞ÂÉπÔºö<span class="latest-price">--</span> | 
                    BuyScoreÔºö<span class="buy-score">--</span>
                </div>
                <canvas class="chart-k"></canvas>
                <canvas class="chart-rsi"></canvas>
                <canvas class="chart-macd"></canvas>
                <div class="analysis-report">ËºâÂÖ•‰∏≠...</div>
            `;
            stocksContainer.appendChild(card);
        });

        // -------------------------------
        // ÂèñÂæó Yahoo Finance Ë≥áÊñô
        // -------------------------------
        async function fetchStockData(symbol) {
            try {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=6mo&interval=1d`;
                const res = await fetch(url);
                const data = await res.json();
                const timestamps = data.chart.result[0].timestamp;
                const quote = data.chart.result[0].indicators.quote[0];
                const close = quote.close;
                const open = quote.open;
                const high = quote.high;
                const low = quote.low;
                const volume = quote.volume;
                return {timestamps, open, high, low, close, volume};
            } catch(err) {
                console.error(symbol, err);
                return null;
            }
        }

        // -------------------------------
        // Ê∏≤ÊüìÂúñË°®ËàáÂàÜÊûê
        // -------------------------------
        async function renderStock(symbol) {
            const data = await fetchStockData(symbol);
            if(!data) return;

            const card = document.getElementById(`stock-${symbol}`);
            const latest = data.close[data.close.length-1];
            const ma20 = SMA(data.close,20).slice(-1)[0] || latest;
            const ma60 = SMA(data.close,60).slice(-1)[0] || latest;
            const ma200 = SMA(data.close,200).slice(-1)[0] || latest;
            const rsi14 = RSI(data.close,14).slice(-1)[0] || 50;
            const macdData = MACD(data.close);
            const macdHist = macdData.histogram.slice(-1)[0] || 0;
            const atrVal = ATR(data.high, data.low, data.close).slice(-1)[0] || 0;
            const atrPercent = (atrVal / latest * 100).toFixed(2);

            const supportRes = getSupportResistance(data.high, data.low, data.close);
            const buyScore = calculateBuyScore(latest, ma20, ma60, ma200, rsi14, macdHist, atrPercent);

            // Êõ¥Êñ∞ÂÉπÊ†ºËàá BuyScore
            card.querySelector('.latest-price').textContent = latest.toFixed(2);
            card.querySelector('.buy-score').textContent = buyScore;

            // Êõ¥Êñ∞ÂàÜÊûêÂ†±Âëä
            const trend = (ma20 > ma60 && ma60 > ma200) ? "üü¢ Âº∑Â§ö" : (ma20 < ma60 && ma60 < ma200) ? "üî¥ Âº∑Á©∫" : "üü° ‰∏≠ÊÄß";
            card.querySelector('.analysis-report').innerHTML = `
                <p>Ë∂®Âã¢Âà§Êñ∑Ôºö${trend}</p>
                <p>RSIÔºö${rsi14.toFixed(2)}</p>
                <p>MA20Ôºö${ma20.toFixed(2)}, MA60Ôºö${ma60.toFixed(2)}, MA200Ôºö${ma200.toFixed(2)}</p>
                <p>ATR%Ôºö${atrPercent}%</p>
                <p>ÊîØÊíêÔºö${supportRes.support.toFixed(2)}, Â£ìÂäõÔºö${supportRes.resistance.toFixed(2)}</p>
            `;

            // -------------------------------
            // Áï´ÂúñË°®
            // -------------------------------
            // K Á∑ö
            new Chart(card.querySelector('.chart-k'), {
                type: 'candlestick',
                data: {
                    labels: data.timestamps.map(t => new Date(t*1000).toLocaleDateString()),
                    datasets: [{
                        label: symbol,
                        data: data.close.map((c,i)=>({
                            o: data.open[i],
                            h: data.high[i],
                            l: data.low[i],
                            c: data.close[i]
                        })),
                        borderColor: '#00ffb0'
                    }]
                },
                options: {
                    plugins: { legend: { display: false } }
                }
            });

            // RSI
            new Chart(card.querySelector('.chart-rsi'), {
                type: 'line',
                data: {
                    labels: data.timestamps.map(t => new Date(t*1000).toLocaleDateString()),
                    datasets: [{
                        label: 'RSI14',
                        data: RSI(data.close,14),
                        borderColor: '#ffeb3b',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: { plugins: { legend: { display: true } } }
            });

            // MACD
            const macd = MACD(data.close);
            new Chart(card.querySelector('.chart-macd'), {
                type: 'bar',
                data: {
                    labels: data.timestamps.map(t => new Date(t*1000).toLocaleDateString()),
                    datasets: [
                        {
                            type: 'line',
                            label: 'MACD',
                            data: macd.macd,
                            borderColor: '#00ffff',
                            fill: false
                        },
                        {
                            type: 'line',
                            label: 'Signal',
                            data: macd.signalLine,
                            borderColor: '#ff00ff',
                            fill: false
                        },
                        {
                            type: 'bar',
                            label: 'Histogram',
                            data: macd.histogram,
                            backgroundColor: '#8888ff'
                        }
                    ]
                },
                options: { plugins: { legend: { display: true } } }
            });
        }

        // -------------------------------
        // ÂàùÂßãÂåñ
        // -------------------------------
        async function init() {
            for(const symbol of stockList){
                await renderStock(symbol);
            }
        }

        init();

        // -------------------------------
        // ÊØè 30 ÁßíÊõ¥Êñ∞
        // -------------------------------
        setInterval(init, 30000);
    </script>
</body>
</html>
