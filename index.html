<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI è‚¡å¸‚å°ˆæ¥­å„€è¡¨æ¿ v6</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; padding:0; background:#121212; color:#e0e0e0; }
header { display:flex; justify-content:space-between; align-items:center; padding:20px 40px; background:#1e1e1e; border-bottom:1px solid #333;}
header h1 { margin:0; font-size:1.8rem;}
header button { padding:8px 16px; font-size:1rem; background:#333; color:#e0e0e0; border:none; border-radius:4px; cursor:pointer;}
header button:hover { background:#555;}
#stocks-container { display:flex; flex-wrap:wrap; gap:15px; padding:20px 40px;}
.stock-card { background:#1f1f1f; border:1px solid #333; border-radius:8px; padding:12px; flex:1 1 300px; display:flex; flex-direction:column; max-height:1000px; overflow:hidden;}
.stock-header { display:flex; justify-content:space-between; align-items:center;}
.stock-header h2 { margin:0; font-size:1.2rem; color:#00ffb0;}
.price-info { font-size:1rem; display:flex; gap:10px; align-items:center; margin-top:4px;}
.buy-score { padding:2px 6px; border-radius:4px; color:#000;}
canvas { width:100% !important; height:250px !important; margin-top:10px; }
.analysis-report { margin-top:10px; background:#2a2a2a; border-radius:6px; padding:10px; font-size:0.9rem; line-height:1.4;}
.dashboard { display:flex; flex-direction:column; gap:20px; padding:20px 40px; }
.section { background:#1f1f1f; border-radius:8px; padding:12px; }
.section h3 { margin:0 0 10px 0; font-size:1.2rem; color:#00ffb0; }
.risk-light { font-weight:bold; font-size:1.1rem; }
.stock-rank { display:flex; flex-direction:column; gap:4px; }
.rank-item { display:flex; justify-content:space-between; padding:4px 8px; border-radius:4px; }
.rank-high { background:#004d00; color:#00ff00; }
.rank-mid { background:#664d00; color:#ffeb3b; }
.rank-low { background:#4d0000; color:#ff3b3b; }
footer { text-align:center; padding:20px 0; background:#1e1e1e; border-top:1px solid #333; font-size:0.9rem; color:#999;}
body.light-mode { background:#f5f5f5; color:#212121;}
body.light-mode header { background:#fff; color:#212121; border-bottom:1px solid #ccc;}
body.light-mode .stock-card { background:#fff; border:1px solid #ccc; color:#212121;}
body.light-mode .analysis-report { background:#eee; color:#212121;}
body.light-mode header button { background:#ddd; color:#212121;}
body.light-mode header button:hover { background:#bbb;}
</style>
</head>
<body>
<header>
<h1>ğŸ“Š AI è‚¡å¸‚å°ˆæ¥­å„€è¡¨æ¿ v6</h1>
<button id="toggleTheme">åˆ‡æ›äº®/æ·±è‰²æ¨¡å¼</button>
</header>
<main class="dashboard">
<div id="stocks-container"></div>
<div class="section">
<h3>ğŸ“‰ å¤§ç›¤é¢¨éšªç‡ˆè™Ÿ</h3>
<div id="market-risk" class="risk-light">è¼‰å…¥ä¸­...</div>
</div>
<div class="section">
<h3>ğŸ† å¤šæª”è‚¡ç¥¨ AI å¼·å¼±æ¦œ</h3>
<div id="stock-rank" class="stock-rank">è¼‰å…¥ä¸­...</div>
</div>
</main>
<footer>
<p>Â© 2025 AI è‚¡å¸‚å„€è¡¨æ¿</p>
</footer>

<script>
// ------------------- è‚¡ç¥¨åˆ—è¡¨ -------------------
const stockList=["2330.TW","2454.TW","0050.TW","0056.TW","VOO"];
const stocksContainer=document.getElementById('stocks-container');
const marketRisk=document.getElementById('market-risk');
const stockRankDiv=document.getElementById('stock-rank');
document.getElementById('toggleTheme').addEventListener('click',()=>{document.body.classList.toggle('light-mode');});
const cardData={};

// ------------------- æŠ€è¡“æŒ‡æ¨™ -------------------
function SMA(data, period){let r=[];for(let i=0;i<data.length;i++){if(i<period-1){r.push(null);continue;}let sum=0;for(let j=i-period+1;j<=i;j++) sum+=data[j];r.push(sum/period);} return r;}
function RSI(data, period=14){let rsi=[];for(let i=0;i<data.length;i++){if(i<period){rsi.push(null);continue;} let gains=0, losses=0; for(let j=i-period+1;j<=i;j++){let diff=data[j]-data[j-1];if(diff>0) gains+=diff; else losses+=-diff;} let r=100-(100/(1+(gains/period)/(losses/period))); rsi.push(r);} return rsi;}
function ATR(high, low, close, period=14){let tr=[]; for(let i=1;i<close.length;i++){tr.push(Math.max(high[i]-low[i], Math.abs(high[i]-close[i-1]), Math.abs(low[i]-close[i-1])));} let atr=[]; for(let i=0;i<tr.length;i++){if(i<period-1){atr.push(null); continue;} let sum=0; for(let j=i-period+1;j<=i;j++) sum+=tr[j]; atr.push(sum/period);} return atr;}
function calculateBuyScore(latest, ma20, ma60, ma200, rsi, atr, volRatio){
    let score=50;
    if(ma20>ma60 && ma60>ma200) score+=20;  
    else if(ma20<ma60 && ma60<ma200) score-=20; 
    if(latest>ma20) score+=10;  
    if(latest<ma200) score-=10;
    if(rsi<30) score+=15;   
    else if(rsi>70) score-=15; 
    if(atr>0 && volRatio>1.2) score+=5; 
    if(atr>0 && volRatio<0.8) score-=5; 
    return Math.min(Math.max(Math.round(score),0),100);
}
function getSupportResistance(high, low){return {support:Math.min(...low.slice(-20)), resistance:Math.max(...high.slice(-20))};}
function getSuggestedEntry(support){return (support*1.02).toFixed(2);}

// ------------------- å»ºç«‹å¡ç‰‡ -------------------
stockList.forEach(symbol=>{
    const card=document.createElement('div'); card.className='stock-card expanded'; card.id=`stock-${symbol}`;
    card.innerHTML=`<div class="stock-header">
        <h2>${symbol}</h2>
        <div class="price-info">æœ€æ–°åƒ¹ï¼š<span class="latest-price">--</span> | BuyScoreï¼š<span class="buy-score">--</span></div>
    </div>
    <canvas class="chart"></canvas>
    <div class="analysis-report">è¼‰å…¥ä¸­...</div>`;
    stocksContainer.appendChild(card);
    cardData[symbol]={card, buyHistory:[], priceHistory:[], chart:null, latest:0};
});

// ------------------- æŠ“ Yahoo Finance -------------------
async function fetchStockData(symbol, range='6mo', interval='1d'){
    try{
        const url=`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${range}&interval=${interval}`)}`;
        const res=await fetch(url);
        const data=await res.json();
        const quote=data.chart.result[0].indicators.quote[0];
        return {
            timestamps:data.chart.result[0].timestamp,
            open:quote.open,
            high:quote.high,
            low:quote.low,
            close:quote.close,
            volume:quote.volume
        };
    }catch(err){console.error(symbol,err); return null;}
}

// ------------------- æ¸²æŸ“å¡ç‰‡ -------------------
async function renderStock(symbol){
    const {card, buyHistory, priceHistory}=cardData[symbol];
    const data=await fetchStockData(symbol,'6mo','1d');
    if(!data) return;

    const latest=data.close[data.close.length-1];
    const ma20=SMA(data.close,20).slice(-1)[0]||latest;
    const ma60=SMA(data.close,60).slice(-1)[0]||latest;
    const ma200=SMA(data.close,200).slice(-1)[0]||latest;
    const rsiVal=RSI(data.close,14).slice(-1)[0]||50;
    const atrVal=ATR(data.high, data.low, data.close,14).slice(-1)[0]||0;
    const recentVolume=data.volume.slice(-3).reduce((a,b)=>a+b,0)/3;
    const avgVolume=data.volume.slice(-20).reduce((a,b)=>a+b,0)/20;
    const volRatio=(recentVolume/avgVolume).toFixed(2);

    const buyScore=calculateBuyScore(latest,ma20,ma60,ma200,rsiVal,atrVal,volRatio);
    card.querySelector('.latest-price').textContent=latest.toFixed(2);
    const buySpan=card.querySelector('.buy-score');
    buySpan.textContent=buyScore;
    buySpan.style.backgroundColor=buyScore>=70?'#00ff00':buyScore>=40?'#ffeb3b':'#ff3b3b';

    buyHistory.push(buyScore); if(buyHistory.length>50) buyHistory.shift();
    priceHistory.push(latest); if(priceHistory.length>50) priceHistory.shift();
    cardData[symbol].latest = buyScore;

    const supportRes=getSupportResistance(data.high, data.low);
    const suggestedEntry=getSuggestedEntry(supportRes.support);
    let suggestion='è§€æœ›';
    if(buyScore>=70) suggestion='å¤šé ­å¼·å‹¢ï¼Œå¯è€ƒæ…®åŠ ç¢¼';
    else if(buyScore>=40) suggestion='ä¸­æ€§ï¼Œæš«ä¸å»ºè­°åŠ ç¢¼';
    else suggestion='å¼±å‹¢ï¼Œå»ºè­°ç­‰å¾…æ”¯æ’å€';

    card.querySelector('.analysis-report').innerHTML=`
        <p>è¶¨å‹¢ï¼š${ma20>ma60&&ma60>ma200?'ğŸŸ¢ å¼·å¤š':ma20<ma60&&ma60<ma200?'ğŸ”´ å¼·ç©º':'ğŸŸ¡ ä¸­æ€§'}</p>
        <p>RSIï¼š${rsiVal.toFixed(2)}</p>
        <p>MA20ï¼š${ma20.toFixed(2)}, MA60ï¼š${ma60.toFixed(2)}, MA200ï¼š${ma200.toFixed(2)}</p>
        <p>æ”¯æ’ï¼š${supportRes.support.toFixed(2)}, å£“åŠ›ï¼š${supportRes.resistance.toFixed(2)}</p>
        <p>å»ºè­°é€²å ´å€ï¼šç´„ ${suggestedEntry}</p>
        <p>ATR æ³¢å‹•åº¦ï¼š${atrVal.toFixed(2)}</p>
        <p>æˆäº¤é‡æ¯”å€¼ï¼š${volRatio}</p>
        <p>AI å»ºè­°ï¼š${suggestion}</p>`;

    // ------------------- ç•«æŠ˜ç·šåœ– -------------------
    if(cardData[symbol].chart){
        cardData[symbol].chart.data.labels = buyHistory.map((_,i)=>i+1);
        cardData[symbol].chart.data.datasets[0].data = priceHistory;
        cardData[symbol].chart.data.datasets[1].data = buyHistory;
        cardData[symbol].chart.update();
    } else {
        const ctx = card.querySelector('canvas').getContext('2d');
        cardData[symbol].chart = new Chart(ctx,{
            type:'line',
            data:{
                labels: buyHistory.map((_,i)=>i+1),
                datasets:[
                    {label:'åƒ¹æ ¼', data:priceHistory, borderColor:'#00bfff', backgroundColor:'rgba(0,191,255,0.2)', yAxisID:'y'},
                    {label:'BuyScore', data:buyHistory, borderColor:'#00ff00', backgroundColor:'rgba(0,255,0,0.2)', yAxisID:'y1'}
                ]
            },
            options:{
                responsive:true,
                interaction:{mode:'index',intersect:false},
                stacked:false,
                scales:{
                    y:{type:'linear', position:'left', title:{display:true,text:'åƒ¹æ ¼'}},
                    y1:{type:'linear', position:'right', title:{display:true,text:'BuyScore'}, min:0, max:100, grid:{drawOnChartArea:false}}
                }
            }
        });
    }
}

// ------------------- å¤§ç›¤é¢¨éšªç‡ˆè™Ÿ -------------------
async function updateMarketRisk(){
    const data=await fetchStockData('0050.TW','6mo','1d');
    if(!data) return;
    const latest=data.close[data.close.length-1];
    const ma20=SMA(data.close,20).slice(-1)[0]||latest;
    const ma60=SMA(data.close,60).slice(-1)[0]||latest;
    const ma200=SMA(data.close,200).slice(-1)[0]||latest;
    const rsiVal=RSI(data.close,14).slice(-1)[0]||50;

    let risk='ğŸŸ¢ ä½é¢¨éšªï¼ˆå¤šé ­å¥åº·ï¼‰';
    if(ma20<ma60 && ma60<ma200 || rsiVal>70) risk='ğŸ”´ é«˜é¢¨éšªï¼ˆç©ºé ­æˆ–è¶…è²·ï¼‰';
    else if((ma20>ma60 && ma60<ma200) || (rsiVal>=50 && rsiVal<=70)) risk='ğŸŸ¡ ä¸­æ€§';
    marketRisk.textContent=risk;
}

// ------------------- æ›´æ–°å¤šæª”è‚¡ç¥¨å¼·å¼±æ¦œ -------------------
function updateStockRank(){
    const sorted=stockList.map(s=>({symbol:s, score:cardData[s].latest})).sort((a,b)=>b.score-a.score);
    stockRankDiv.innerHTML='';
    sorted.forEach(item=>{
        const div=document.createElement('div');
        div.className='rank-item '+(item.score>=70?'rank-high':item.score>=40?'rank-mid':'rank-low');
        div.textContent=`${item.symbol} | BuyScore: ${item.score}`;
        stockRankDiv.appendChild(div);
    });
}

// ------------------- åˆå§‹åŒ– -------------------
async function init(){
    for(const s of stockList) await renderStock(s);
    updateMarketRisk();
    updateStockRank();
}
init();

// ------------------- è‡ªå‹•åˆ·æ–° -------------------
setInterval(async()=>{
    for(const s of stockList) await renderStock(s);
    updateMarketRisk();
    updateStockRank();
},5000);
</script>
</body>
</html>
